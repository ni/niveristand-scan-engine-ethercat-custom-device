trigger:
  batch: true
  branches:
    include:
      - main
      - release/*

resources:
  repositories:
    - repository: niveristand-custom-device-build-tools
      type:       github
      ref:        main
      endpoint:   nivs-custom-devices
      name:       ni/niveristand-custom-device-build-tools
  pipelines:
    - pipeline: FxpLibraries
      source:   ni.niveristand-scan-engine-fxp-libraries
      trigger:  
        branches: 
          include:
            - main
    - pipeline: ModuleLibraries
      source:   ni.niveristand-scan-engine-module-libraries
      trigger:  
        branches: 
          include:
            - main

stages:
  - stage: Copy_cRIO_DLLs
    jobs:
      - job: CopyCrioDll
        steps:
          - task: PowerShell@2
            displayName: Copy CRIO DLLs to Includes/cRIO folder
            inputs:
              script: |
                # Set strict mode and stop on errors
                Set-StrictMode -Version Latest
                $ErrorActionPreference = "Stop"
                
                # Define paths
                $sourceZip = "\\nirvana\perforceExports\build\exports\ni\bb_l\bb_lib\official\export\25.3\25.3.0f114\.archives\windows.zip"
                $tempDir = "$PSScriptRoot\temp_extract"
                $includeDir = "$PSScriptRoot\Includes\cRIO"
                
                # Ensure directories exist
                if (!(Test-Path -Path $tempDir)) {
                    New-Item -ItemType Directory -Path $tempDir | Out-Null
                }
                if (!(Test-Path -Path $includeDir)) {
                    New-Item -ItemType Directory -Path $includeDir -Force | Out-Null
                }
                
                # Copy the ZIP file to the temp directory
                Write-Host "Copying windows.zip..."
                Copy-Item -Path $sourceZip -Destination "$tempDir\windows.zip" -Force
                
                # Extract the zip file
                Write-Host "Extracting windows.zip..."
                Expand-Archive -Path "$tempDir\windows.zip" -DestinationPath $tempDir -Force
                
                # Define DLL source paths inside the extracted content
                $dll1 = Join-Path $tempDir "dist\win32U\RIOCommonFiles\LabVIEW\resource\Framework\Providers\nNIBlueBus_nCrioFixed.dll"
                $dll2 = Join-Path $tempDir "dist\win32U\RIOCommonFiles\LabVIEW\resource\nNIBlueBus_nCrioFixed_nRefnum.dll"
                
                # Copy DLLs to Includes/cRIO
                Write-Host "Copying DLLs..."
                Copy-Item -Path $dll1 -Destination $includeDir -Force
                Copy-Item -Path $dll2 -Destination $includeDir -Force
                
                # Clean up temporary files
                Write-Host "Cleaning up temporary files..."
                Remove-Item -Path $tempDir -Recurse -Force
                
                Write-Host "Done."

  - template: azure-templates/stages.yml@niveristand-custom-device-build-tools
    parameters:

      lvVersionsToBuild:
        - version: '2023'
          bitness: '64bit'
        - version: '2023'
          bitness: '32bit'
        - version: '2024'
          bitness: '64bit'
        - version: '2024'
          bitness: '32bit'
        - version: '2025'
          bitness: '64bit'
        - version: '2025'
          bitness: '32bit'

      dependencies:
        - source: '\\nirvana\Measurements\VeriStandAddons\scan_engine_fxp'
          file: '$target\FXP.llb'
          destination: 'Includes'
        - source: '\\nirvana\Measurements\VeriStandAddons\scan_engine_modules'
          file: '$target\Modules.lvlibp'
          destination: 'Includes'
        - source: '\\nirvana\Measurements\VeriStandAddons\scan_engine_modules'
          file: '$target\NI ECAT Remote IO.llb'
          destination: 'Includes'

      silenceDependencyFailures: true

      codegenVis:
        - 'Custom Device Source\Build VIs\Delete Scripting API.vi'

      buildSteps:
        - projectLocation: 'Custom Device Source\Scan Engine.lvproj'
          buildOperation: 'ExecuteBuildSpec'
          target: 'My Computer'
          buildSpec: 'Configuration Release'
          exclusions:
            - version: '2023'
              bitness: '32bit'
            - version: '2024'
              bitness: '32bit'
            - version: '2025'
              bitness: '32bit'

        - projectLocation: 'Custom Device Source\Scan Engine.lvproj'
          buildOperation: 'ExecuteBuildSpec'
          target: 'My Computer'
          buildSpec: 'Revert to Scan Mode'
          exclusions:
            - version: '2023'
              bitness: '64bit'
            - version: '2024'
              bitness: '64bit'
            - version: '2025'
              bitness: '64bit'

        - projectLocation: 'Custom Device Source\Scan Engine.lvproj'
          buildOperation: 'ExecuteBuildSpec'
          target: 'My Computer'
          buildSpec: 'Get HW Config'
          exclusions:
            - version: '2023'
              bitness: '64bit'
            - version: '2024'
              bitness: '64bit'
            - version: '2025'
              bitness: '64bit'

        - projectLocation: 'Custom Device Source\Scan Engine.lvproj'
          buildOperation: 'ExecuteBuildSpec'
          target: 'My Computer'
          buildSpec: 'Check and Download Bitfile'
          exclusions:
            - version: '2023'
              bitness: '64bit'
            - version: '2024'
              bitness: '64bit'
            - version: '2025'
              bitness: '64bit'

        - projectLocation: 'Custom Device Source\Scan Engine.lvproj'
          buildOperation: 'ExecuteBuildSpec'
          target: 'My Computer'
          buildSpec: 'Import ESI File'
          exclusions:
            - version: '2023'
              bitness: '64bit'
            - version: '2024'
              bitness: '64bit'
            - version: '2025'
              bitness: '64bit'

        - projectLocation: 'Custom Device Source\Scan Engine.lvproj'
          buildOperation: 'ExecuteBuildSpec'
          target: 'My Computer'
          buildSpec: 'Read Target ESI Files'
          exclusions:
            - version: '2023'
              bitness: '64bit'
            - version: '2024'
              bitness: '64bit'
            - version: '2025'
              bitness: '64bit'

        - projectLocation: 'Custom Device Source\Scan Engine Linux x64.lvproj'
          buildOperation: 'ExecuteBuildSpec'
          target: 'Linux x64'
          buildSpec: 'Engine Release'
          exclusions:
            - version: '2023'
              bitness: '64bit'
            - version: '2024'
              bitness: '64bit'
            - version: '2025'
              bitness: '64bit'

        - projectLocation: 'Custom Device Source\Scan Engine.lvproj'
          buildOperation: 'ExecuteBuildSpec'
          target: 'My Computer'
          buildSpec: 'Scripting API'
          exclusions:
            - version: '2023'
              bitness: '32bit'
            - version: '2024'
              bitness: '32bit'
            - version: '2025'
              bitness: '32bit'

        - projectLocation: 'Scripting Examples\Scan Engine Scripting Examples.lvproj'
          buildOperation: 'ExecuteBuildSpec'
          target: 'My Computer'
          buildSpec: 'Examples'
          exclusions:
            - version: '2023'
              bitness: '32bit'
            - version: '2024'
              bitness: '32bit'
            - version: '2025'
              bitness: '32bit'

      releaseVersion: '25.0.0'
      buildOutputLocation: 'Built'
      archiveLocation: '\\nirvana\Measurements\VeriStandAddons\scan_engine_custom_device'
      packages:
        - controlFileName: 'control'
          payloadMaps:
            - payloadLocation: 'Scan Engine'
              installLocation: 'documents\National Instruments\NI VeriStand $(lvVersion)\Custom Devices\Scan Engine'
            - payloadLocation: 'Errors'
              installLocation: 'ni-paths-NISHAREDDIR$(nipkgx64suffix)\LabVIEW Run-Time\$(lvVersion)\errors\English'

        - controlFileName: 'control_scripting'
          payloadMaps:
            - payloadLocation: 'Scripting\Scan Engine'
              installLocation: 'ni-paths-LV$(lvVersion)DIR$(nipkgx64suffix)\vi.lib\addons\VeriStand Custom Device Scripting APIs\Scan Engine'

        - controlFileName: 'control_examples'
          payloadMaps:
            - payloadLocation: 'Examples\Scan Engine'
              installLocation: 'ni-paths-LV$(lvVersion)DIR$(nipkgx64suffix)\examples\NI VeriStand Custom Devices\Scan Engine'
